{{ $related := .Site.RegularPages.Related . | first 5 }}
{{ $relatedCount := len $related }}

{{ if lt $relatedCount 5 }}
    {{ $remaining := sub 5 $relatedCount }}
    {{ $recent := where .Site.RegularPages "Section" .Section | first $remaining }}
    {{ $combined := $related | union $recent | uniq }}
    {{ $final := where $combined "Permalink" "!=" .Permalink | first 5 }}
    {{ $.Scratch.Set "finalPages" $final }}
{{ else }}
    {{ $final := where $related "Permalink" "!=" .Permalink | first 5 }}
    {{ $.Scratch.Set "finalPages" $final }}
{{ end }}

{{ $finalPages := $.Scratch.Get "finalPages" }}

{{ if not $finalPages }}
    {{ $fallback := where .Site.RegularPages "Section" .Section | first 5 }}
    {{ $fallbackFinal := where $fallback "Permalink" "!=" .Permalink | first 5 }}
    {{ $.Scratch.Set "finalPages" $fallbackFinal }}
{{ end }}

{{ $finalPages = $.Scratch.Get "finalPages" }}

<aside class="related-posts">
    <h3 class="related-posts-title">
        {{ if eq $.Section "snippets" }}
        Related Snippets
        {{ else }}
        Related Posts
        {{ end }}
    </h3>
    <div class="related-posts-list">
        {{ range $finalPages }}
        <article class="related-post-item">
            <h4 class="related-post-title">
                <a href="{{ .RelPermalink }}">{{ .Title }}</a>
            </h4>
        </article>
        {{ end }}
        {{ if not $finalPages }}
        <p class="no-related-content">No related content found.</p>
        {{ end }}
    </div>
</aside>